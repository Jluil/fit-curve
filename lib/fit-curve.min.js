/*
  JavaScript implementation of
  Algorithm for Automatically Fitting Digitized Curves
  by Philip J. Schneider
  "Graphics Gems", Academic Press, 1990

  The MIT License (MIT)

  https://github.com/soswow/fit-curves
*/
(function(y,v){if("function"===typeof define&&define.amd)define(["module"],v);else if("undefined"!==typeof exports)v(module);else{var w={exports:{}};v(w);y.fitCurve=w.exports}})(this,function(y){function v(b,c){if(!(b instanceof c))throw new TypeError("Cannot call a class as a function");}function w(b,c,a,g,k){var m,f,n,l,h,e,p,q;if(2===b.length)return g=d.vectorLen(d.subtract(b[0],b[1]))/3,m=[b[0],d.addArrays(b[0],d.mulItems(c,g)),d.addArrays(b[1],d.mulItems(a,g)),b[1]],[m];f=A(b);e=z(b,f,f,c,a,
k);m=e[0];l=e[1];e=e[2];if(l<g)return[m];if(l<g*g)for(n=f,h=l,p=e,q=0;20>q;q++){n=B(m,b,n);e=z(b,f,n,c,a,k);m=e[0];l=e[1];e=e[2];if(l<g)return[m];if(e===p&&(h=l/h,.9999<h&&1.0001>h))break;h=l;p=e}m=[];f=d.subtract(b[e-1],b[e+1]);0===f[0]&&0===f[1]&&(f=d.subtract(b[e-1],b[e]).reverse(),f[0]=-f[0]);f=d.normalize(f);l=d.mulItems(f,-1);m=m.concat(w(b.slice(0,e+1),c,f,g,k));return m=m.concat(w(b.slice(e),l,a,g,k))}function z(b,c,a,g,k,m){var f,n,l,h,e,p,q,t,r=b[0],u=b[b.length-1];f=[r,null,null,u];n=d.zeros_Xx2x2(a.length);
p=0;for(q=a.length;p<q;p++)t=a[p],h=1-t,l=n[p],l[0]=d.mulItems(g,3*t*h*h),l[1]=d.mulItems(k,3*h*t*t);h=[[0,0],[0,0]];e=[0,0];p=0;for(q=b.length;p<q;p++)t=a[p],l=n[p],h[0][0]+=d.dot(l[0],l[0]),h[0][1]+=d.dot(l[0],l[1]),h[1][0]+=d.dot(l[0],l[1]),h[1][1]+=d.dot(l[1],l[1]),t=d.subtract(b[p],x.q([r,r,u,u],t)),e[0]+=d.dot(l[0],t),e[1]+=d.dot(l[1],t);a=h[0][0]*h[1][1]-h[1][0]*h[0][1];n=h[0][0]*e[1]-h[1][0]*e[0];h=e[0]*h[1][1]-e[1]*h[0][1];h=0===a?0:h/a;e=0===a?0:n/a;n=d.vectorLen(d.subtract(r,u));a=1E-6*
n;h<a||e<a?(f[1]=d.addArrays(r,d.mulItems(g,n/3)),f[2]=d.addArrays(u,d.mulItems(k,n/3))):(f[1]=d.addArrays(r,d.mulItems(g,h)),f[2]=d.addArrays(u,d.mulItems(k,e)));g=0;k=b.length/2;h=C(f,10);r=0;for(u=b.length;r<u;r++){e=b[r];a=c[r];if(0>a)a=0;else if(1<a)a=1;else{n=void 0;for(q=1;10>=q;q++)if(a<=h[q]){p=(q-1)/10;l=q/10;n=h[q-1];q=h[q];n=(a-n)/(q-n)*(l-p)+p;break}a=n}e=d.subtract(x.q(f,a),e);e=e[0]*e[0]+e[1]*e[1];e>g&&(g=e,k=r)}k=[g,k];g=k[0];k=k[1];m&&m({bez:f,points:b,params:c,maxErr:g,maxPoint:k});
return[f,g,k]}function B(b,c,a){return a.map(function(a,k){var g=c[k],f=d.subtract(x.q(b,a),g),n=x.qprime(b,a),g=d.mulMatrix(f,n),f=d.sum(d.addItems(d.squareItems(n),d.mulMatrix(f,x.qprimeprime(b,a))));return 0===f?a:a-g/f})}function A(b){var c=[],a,g,k;b.forEach(function(b,f){a=f?g+d.vectorLen(d.subtract(b,k)):0;c.push(a);g=a;k=b});return c=c.map(function(a){return a/g})}var C=function(b,c){for(var a,g=[0],k=b[0],m=0,f=1;f<=c;f++)a=x.q(b,f/c),m+=d.vectorLen(d.subtract(a,k)),g.push(m),k=a;return g=
g.map(function(a){return a/m})},d=function(){function b(){v(this,b)}b.zeros_Xx2x2=function(c){for(var a=[];c--;)a.push([0,0]);return a};b.mulItems=function(c,a){return[c[0]*a,c[1]*a]};b.mulMatrix=function(c,a){return c[0]*a[0]+c[1]*a[1]};b.subtract=function(c,a){return[c[0]-a[0],c[1]-a[1]]};b.addArrays=function(c,a){return[c[0]+a[0],c[1]+a[1]]};b.addItems=function(c,a){return[c[0]+a,c[1]+a]};b.sum=function(c){return c.reduce(function(a,c){return a+c})};b.dot=function(c,a){return b.mulMatrix(c,a)};
b.vectorLen=function(c){var a=c[0];c=c[1];return Math.sqrt(a*a+c*c)};b.divItems=function(c,a){return[c[0]/a,c[1]/a]};b.squareItems=function(c){var a=c[0];c=c[1];return[a*a,c*c]};b.normalize=function(c){return this.divItems(c,this.vectorLen(c))};return b}(),x=function(){function b(){v(this,b)}b.q=function(c,a){var b=1-a,k=d.mulItems(c[0],b*b*b),m=d.mulItems(c[1],3*b*b*a),b=d.mulItems(c[2],3*b*a*a),f=d.mulItems(c[3],a*a*a);return d.addArrays(d.addArrays(k,m),d.addArrays(b,f))};b.qprime=function(b,a){var c=
1-a,k=d.mulItems(d.subtract(b[1],b[0]),3*c*c),c=d.mulItems(d.subtract(b[2],b[1]),6*c*a),m=d.mulItems(d.subtract(b[3],b[2]),3*a*a);return d.addArrays(d.addArrays(k,c),m)};b.qprimeprime=function(b,a){return d.addArrays(d.mulItems(d.addArrays(d.subtract(b[2],d.mulItems(b[1],2)),b[0]),6*(1-a)),d.mulItems(d.addArrays(d.subtract(b[3],d.mulItems(b[2],2)),b[1]),6*a))};return b}();y.exports=function(b,c,a){b=b.filter(function(a,c){return 0===c||!(a[0]===b[c-1][0]&&a[1]===b[c-1][1])});var g=b.length,k=d.normalize(d.subtract(b[1],
b[0])),g=d.normalize(d.subtract(b[g-2],b[g-1]));return w(b,k,g,c,a)}});
